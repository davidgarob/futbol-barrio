<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FM de Barrio (prototipo)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    h1 { margin: 0 0 8px; }
    #log { white-space: pre-wrap; border: 1px solid #ddd; padding: 12px; border-radius: 8px; min-height: 240px; }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid #bbb; cursor: pointer; }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap: wrap; }
    .tag { background:#eee; padding:2px 8px; border-radius: 999px; font-size: 12px; }
  </style>
</head>
<body>
  <h1>Football Manager de Barrio ‚Äî Prototipo 0.1</h1>
  <div class="row">
    <div class="tag">N = 12 jugadas</div>
    <div class="tag">base_conv = 0.18</div>
    <div class="tag">local√≠a ON</div>
  </div>
  <div class="row">
    <button id="btnSimular">Simular partido</button>
    <button id="btnEvento">Robar evento</button>
    <button id="btnLimpiar">Limpiar log</button>
  </div>
  <div id="log">Pulsa ‚ÄúSimular partido‚Äù.</div>

<script>
// ======= DATA =======
const equipoT = {
  nombre: "CD Los Troncos",
  moral: 7, local: true,
  jugadores: [
    {nombre:"Paco 'Botellines'", rol:"GK", tecnica:3, velocidad:2, fuerza:3, resaca:9, carisma:4, reflejos:6},
    {nombre:"Manolo 'Condicional'", rol:"DEF", tecnica:2, velocidad:4, fuerza:7, resaca:3, carisma:2},
    {nombre:"Charly 'Speedy'", rol:"ATK", tecnica:6, velocidad:8, fuerza:3, resaca:5, carisma:6},
    {nombre:"Tato", rol:"MID", tecnica:6, velocidad:5, fuerza:4, resaca:2, carisma:5},
    {nombre:"Guti de Barrio", rol:"MID", tecnica:7, velocidad:4, fuerza:3, resaca:4, carisma:5},
    {nombre:"El Mudo", rol:"DEF", tecnica:3, velocidad:4, fuerza:6, resaca:1, carisma:1},
    {nombre:"Pollo", rol:"ATK", tecnica:5, velocidad:6, fuerza:3, resaca:2, carisma:4},
    {nombre:"Pana", rol:"DEF", tecnica:4, velocidad:3, fuerza:6, resaca:3, carisma:3},
    {nombre:"Nano", rol:"MID", tecnica:5, velocidad:5, fuerza:4, resaca:1, carisma:5},
    {nombre:"Largo", rol:"DEF", tecnica:3, velocidad:5, fuerza:7, resaca:2, carisma:3},
    {nombre:"Pitu", rol:"ATK", tecnica:6, velocidad:6, fuerza:3, resaca:2, carisma:4},
    {nombre:"El Primo", rol:"MID", tecnica:5, velocidad:4, fuerza:4, resaca:3, carisma:6},
  ]
};

const equipoR = {
  nombre: "Pe√±a La Farola",
  moral: 5, local: false,
  jugadores: [
    {nombre:"Porterito", rol:"GK", tecnica:3, velocidad:3, fuerza:3, resaca:2, carisma:4, reflejos:7},
    {nombre:"El Cojo de Cueto", rol:"DEF", tecnica:3, velocidad:3, fuerza:4, resaca:2, carisma:2},
    {nombre:"Juanito Wifi", rol:"ATK", tecnica:6, velocidad:5, fuerza:3, resaca:4, carisma:5},
    {nombre:"Tiki", rol:"MID", tecnica:6, velocidad:4, fuerza:3, resaca:2, carisma:5},
    {nombre:"Taka", rol:"MID", tecnica:5, velocidad:5, fuerza:3, resaca:3, carisma:5},
    {nombre:"Panza", rol:"DEF", tecnica:3, velocidad:3, fuerza:5, resaca:3, carisma:3},
    {nombre:"Zapa", rol:"ATK", tecnica:5, velocidad:5, fuerza:4, resaca:3, carisma:4},
    {nombre:"Rulo", rol:"DEF", tecnica:3, velocidad:4, fuerza:6, resaca:4, carisma:3},
    {nombre:"Chispa", rol:"MID", tecnica:5, velocidad:5, fuerza:4, resaca:2, carisma:4},
    {nombre:"Tibur", rol:"DEF", tecnica:4, velocidad:4, fuerza:5, resaca:2, carisma:3},
    {nombre:"Mono", rol:"ATK", tecnica:5, velocidad:6, fuerza:3, resaca:2, carisma:4},
    {nombre:"Fofo", rol:"MID", tecnica:4, velocidad:4, fuerza:4, resaca:3, carisma:4},
  ]
};

const mazoEventos = [
  { id:"perro", nombre:"Perro en el campo", efecto:"swap_possesion_next" },
  { id:"condicional", nombre:"Condicional", efecto:"def_down_team", dur: "full", factor:0.85, equipo:"T" },
  { id:"mafia", nombre:"Llamada de la mafia", efecto:"goal_bribe_team", equipo:"T" },
  { id:"resacaGK", nombre:"Portero de resaca", efecto:"gk_down_team", ticks:4, factor:0.8, equipo:"R" },
  { id:"feria", nombre:"Feria encima del campo", efecto:"reduce_plays", amount:2 },
  { id:"arbitroPrimo", nombre:"√Årbitro primo", efecto:"boost_conv_once", amount:0.10, equipo:"T" },
];

// ======= MOTOR =======
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
function rnd(){ return Math.random(); }

function rolATK(j){ return 0.6*j.tecnica + 0.4*j.velocidad - 0.3*(j.resaca||0); }
function rolMID(j){ return 0.5*j.tecnica + 0.3*j.velocidad + 0.2*(j.carisma||0) - 0.2*(j.resaca||0); }
function rolDEF(j){ return 0.5*j.fuerza + 0.3*j.velocidad + 0.2*j.tecnica - 0.2*(j.resaca||0); }
function rolGK (j){ return 0.7*(j.reflejos||0) + 0.3*(j.carisma||0) - 0.3*(j.resaca||0); }

function ratingEquipo(equipo){
  const atk = [...equipo.jugadores].filter(j=>j.rol==="ATK").map(rolATK).sort((a,b)=>b-a);
  const def = [...equipo.jugadores].filter(j=>j.rol==="DEF").map(rolDEF).sort((a,b)=>b-a);
  const mids = equipo.jugadores.filter(j=>j.rol==="MID").map(rolMID);
  const gkJ = equipo.jugadores.find(j=>j.rol==="GK");
  const GK = gkJ ? rolGK(gkJ) : 0;

  const A = (atk[0]||0 + atk[1]||0)/2 + 0.3*(mids.length? (mids.reduce((a,b)=>a+b,0)/mids.length):0);
  const D = (def[0]||0 + def[1]||0)/2 + 0.4*GK;
  return {A,D,GK};
}

function moralMul(m){ return 1 + (m - 5) * 0.04; }
function homeMul(isHome){ return isHome ? 1.05 : 1.00; }

function simularPartido(teamT, teamR, options={}){
  const log = [];
  const Nbase = options.N || 12;
  let N = Nbase;

  // Estados temporales
  let boostConvOnce = 0;         // del √°rbitro primo
  let swapNext = false;          // perro en el campo
  let gkDownTicks_R = 0, gkDownFactor_R = 1.0;
  let defDown_T = 1.0;

  // Ratings base
  function calcRatings(){
    const RT = ratingEquipo(teamT);
    const RR = ratingEquipo(teamR);

    let A_T = RT.A, D_T = RT.D, GK_T = RT.GK;
    let A_R = RR.A, D_R = RR.D, GK_R = RR.GK;

    const mulT = moralMul(teamT.moral) * homeMul(teamT.local);
    const mulR = moralMul(teamR.moral) * homeMul(teamR.local);

    A_T *= mulT; D_T *= mulT;
    A_R *= mulR; D_R *= mulR;

    // Efectos temporales
    D_T *= defDown_T;
    GK_R *= gkDownFactor_R;

    return { A_T, D_T, GK_T, A_R, D_R, GK_R };
  }

  // roba evento
  function robarEvento(){
    const carta = mazoEventos[Math.floor(rnd()*mazoEventos.length)];
    switch(carta.efecto){
      case "swap_possesion_next":
        swapNext = true;
        log.push("üü° Evento: Perro en el campo ‚Äî La siguiente jugada cambia de posesi√≥n.");
        break;
      case "def_down_team":
        defDown_T = Math.min(defDown_T, carta.factor||0.85);
        log.push("üü° Evento: Condicional ‚Äî Baja tu defensa para el resto del partido.");
        break;
      case "goal_bribe_team":
        log.push("üü° Evento: Llamada de la mafia ‚Äî ¬øAceptas +1 gol a cambio de -Moral 2 partidos? (Fingimos que s√≠)");
        golesT++;
        break;
      case "gk_down_team":
        gkDownTicks_R = carta.ticks||4;
        gkDownFactor_R = carta.factor||0.8;
        log.push("üü° Evento: Portero rival de resaca ‚Äî GK rival reducido por 4 jugadas.");
        break;
      case "reduce_plays":
        N = Math.max(6, N- (carta.amount||2));
        log.push("üü° Evento: Feria ‚Äî Se reducen las jugadas totales.");
        break;
      case "boost_conv_once":
        boostConvOnce += (carta.amount||0.1);
        log.push("üü° Evento: √Årbitro primo ‚Äî +0.10 a conversi√≥n en la pr√≥xima ocasi√≥n a favor.");
        break;
    }
  }

  // marcador
  let golesT = 0, golesR = 0;

  // Bucle de jugadas
  for(let i=1;i<=N;i++){
    // Cada 3 jugadas, evento
    if(i===1 || i===4 || i===7 || i===10) robarEvento();

    const { A_T, D_T, GK_T, A_R, D_R, GK_R } = calcRatings();

    // ¬øQui√©n ataca?
    let pT = clamp(0.50 + 0.04 * ((A_T - D_R)/5), 0.20, 0.80);
    let atacante = (rnd() < pT) ? "T" : "R";

    if(swapNext){ atacante = atacante==="T"?"R":"T"; swapNext=false; }

    // Prob. conversi√≥n
    const baseConv = 0.18;
    let conv;
    if(atacante==="T"){
      conv = baseConv + 0.02 * clamp((A_T - D_R)/5, -3, 3) - 0.01 * clamp(GK_R/2, 0, 4);
      conv += boostConvOnce; boostConvOnce = 0; // se consume
    } else {
      conv = baseConv + 0.02 * clamp((A_R - D_T)/5, -3, 3) - 0.01 * clamp(GK_T/2, 0, 4);
    }
    conv = clamp(conv, 0.05, 0.45);

    const tiro = rnd();
    const gol = tiro < conv;

    // Narraci√≥n m√≠nima
    const lado = atacante==="T" ? teamT.nombre : teamR.nombre;
    log.push(`Jugada ${i}: ataca ${lado}. Conv=${(conv*100).toFixed(1)}% ‚Üí ${gol? "¬°GOL!":"nada..."}`);

    if(gol){
      if(atacante==="T") golesT++; else golesR++;
    }

    // Contadores de efectos
    if(gkDownTicks_R>0){ gkDownTicks_R--; if(gkDownTicks_R===0) gkDownFactor_R = 1.0; }
  }

  log.push(`\nüßæ FINAL: ${teamT.nombre} ${golesT} - ${golesR} ${teamR.nombre}`);
  return log.join("\n");
}

// ======= UI =======
const $log = document.getElementById('log');
document.getElementById('btnSimular').onclick = () => {
  $log.textContent = simularPartido(equipoT, equipoR, {N:12});
};
document.getElementById('btnEvento').onclick = () => {
  // Simula ‚Äúrobar evento‚Äù en medio del texto para verlos sin partido
  $log.textContent += "\n\n(Ejemplo de robo de evento suelto)";
  const tmp = simularPartido(equipoT, equipoR, {N:0}); // ejecuta eventos sin jugadas
  // (Hacemos un hack r√°pido: llamar a robarEvento necesita refactor. Para demo, omitimos.)
  $log.textContent += "\n[Pulsa Simular para ver eventos aplicados en el flujo real]";
};
document.getElementById('btnLimpiar').onclick = () => $log.textContent = "Log limpio.";
</script>
</body>
</html>